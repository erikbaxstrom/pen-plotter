<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pen Plotter</title>
  </head>
  <body>
    <h1>Pen Plotter</h1>
    <h2>Move</h2>
    <div id="leftNudgeControls">
      <h3>Left Motor</h3>
    </div>

    <div id="rightNudgeControls">
      <h3>Right Motor</h3>
    </div>
    <!-- <button id="leftUp1">Up 1 mm</button>
    <button id="leftUp10">Up 10 mm</button>
    <button id="leftUp100">Up 100 mm</button>
    <button id="leftDown1">Down 1 mm</button>
    <button id="leftDown10">Down 10 mm</button>
    <button id="leftDown100">Down 100 mm</button> -->

    <hr />
    <h2>Print</h2>
    <input type="file" id="file" name="name" />
    <button id="upload">Upload gcode</button>
    <button id="print" disabled="true">Print</button>

    <script>
      // Imports
      // (none)

      // Get DOM Elements
      const file = document.getElementById("file");
      const upload = document.getElementById("upload");
      const printButton = document.getElementById("print");

      const leftNudgeControls = document.getElementById("leftNudgeControls");
      const rightNudgeControls = document.getElementById("rightNudgeControls");
      // const leftUp1Button = document.getElementById("leftUp1");
      // const leftUp10Button = document.getElementById("leftUp10");
      // const leftUp100Button = document.getElementById("leftUp100");
      // const leftDown1Button = document.getElementById("leftDown1");
      // const leftDown10Button = document.getElementById("leftDown10");
      // const leftDown100Button = document.getElementById("leftDown100");

      // State
      let nudgeButtons = [
        { name: "Up 100 mm", id: "Up100", dist: 100 },
        { name: "Up 10 mm", id: "Up10", dist: 10 },
        { name: "Up 1 mm", id: "Up1", dist: 1 },
        { name: "Down 1 mm", id: "Down1", dist: -1 },
        { name: "Down 10 mm", id: "Down10", dist: -10 },
        { name: "Down 100 mm", id: "Down100", dist: -100 },
      ];

      // Events

      window.addEventListener("load", async () => {
        displayNudgeButtons();
      });

      upload.addEventListener("click", () => {
        event.preventDefault();
        const fileReader = new FileReader();
        fileReader.readAsArrayBuffer(file.files[0]);
        fileReader.onload = async (event) => {
          const content = event.target.result;
          const chunkSize = 14 * 1024;
          const totalChunks = Math.ceil(content.byteLength / chunkSize);
          console.log("total chunks", totalChunks);
          console.log("file name", file.files[0].name);

          // //file segmentation
          for (let chunkNumber = 0; chunkNumber < totalChunks; chunkNumber++) {
            console.log("doing chunk number", chunkNumber);
            let fileChunk = content.slice(
              chunkNumber * chunkSize,
              (chunkNumber + 1) * chunkSize
            );
            const start = chunkNumber * chunkSize;
            const contentRange = `bytes ${start}/${content.byteLength}`;
            const fileName = file.files[0].name;
            let payload = {
              method: "POST",
              headers: {
                "Content-Type": "application/octet-stream",
                "Content-Length": fileChunk.byteLength,
                "Content-Range": contentRange,
                "Content-Disposition": `attachment; filename="${fileName}"`,
              },
              body: fileChunk,
            };
            console.log("payload", payload);
            await fetch("/upload", payload);
            printButton.disabled = false;
          }
        };
      });

      printButton.addEventListener("click", () => {
        event.preventDefault();
        console.log("starting print");
        printButton.disabled = true;
        fetch("/print");
      });

      // Display Functions
      function displayNudgeButtons() {
        //left side
        for (const nudgeButton of nudgeButtons) {
          const buttonEl = renderNudgeButton(nudgeButton, "l");
          leftNudgeControls.append(buttonEl);
          buttonEl.addEventListener("click", async () => {
            let url = new URL("../nudge", document.baseURI);
            url.searchParams.append("motor", "l");
            url.searchParams.append("mm", nudgeButton.dist);
            fetch(url);
          });
        }
        //right side
        for (const nudgeButton of nudgeButtons) {
          const buttonEl = renderNudgeButton(nudgeButton, "r");
          rightNudgeControls.append(buttonEl);
          buttonEl.addEventListener("click", async () => {
            let url = new URL("../nudge", document.baseURI);
            url.searchParams.append("motor", "r");
            url.searchParams.append("mm", nudgeButton.dist);
            fetch(url);
          });
        }
      }

      //Render Utils

      function renderNudgeButton(nudgeButton, side) {
        const button = document.createElement("button");
        button.id = side + nudgeButton.id;
        button.textContent = nudgeButton.name;
        return button;
      }
    </script>
  </body>
</html>
